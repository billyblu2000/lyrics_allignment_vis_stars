<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歌词对齐数据可视化</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .file-input {
            margin: 10px 0;
        }
        
        .file-input label {
            display: inline-block;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .file-input input[type="file"] {
            display: none;
        }
        
        .audio-controls {
            margin: 20px 0;
            text-align: center;
        }
        
        audio {
            width: 100%;
            max-width: 600px;
        }
        
        .lyrics-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .phonemes-section, .words-section {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .phoneme, .word {
            display: inline-block;
            margin: 2px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f0f0f0;
            font-size: 14px;
        }
        
        .word {
            font-size: 16px;
            margin: 3px;
            padding: 6px 10px;
        }
        
        .current {
            background: #ffeb3b !important;
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .technique-indicators {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .technique-row {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        
        .technique-name {
            width: 120px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .technique-track {
            flex: 1;
            height: 20px;
            display: flex;
        }
        
        .technique-segment {
            height: 100%;
        }
        
        .technique-active {
            opacity: 0.8;
        }
        
        .technique-inactive {
            opacity: 0.2;
        }
        
        /* 不同技巧的颜色 */
        .pharyngeal { background-color: #ff9800; }
        .glissando { background-color: #2196f3; }
        .strong { background-color: #f44336; }
        .vibrato { background-color: #9c27b0; }
        .falsetto { background-color: #00bcd4; }
        .bubble { background-color: #4caf50; }
        .breathe { background-color: #795548; }
        .weak { background-color: #607d8b; }
        
        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-family: monospace;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>歌词对齐数据可视化</h1>
        
        <div class="controls">
            <div class="file-input">
                <label for="jsonFile">选择JSON文件</label>
                <input type="file" id="jsonFile" accept=".json" />
                <span id="jsonStatus">未选择文件</span>
            </div>
            
            <div class="file-input">
                <label for="audioFile">选择音频文件</label>
                <input type="file" id="audioFile" accept="audio/*" />
                <span id="audioStatus">未选择文件</span>
            </div>
        </div>
        
        <div class="audio-controls">
            <audio id="audioPlayer" controls style="display: none;">
                您的浏览器不支持音频播放。
            </audio>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
        </div>
        
        <div class="lyrics-container">
            <div class="phonemes-section">
                <div class="section-title">音素序列 (Phonemes)</div>
                <div id="phonemesDisplay"></div>
            </div>
            
            <div class="words-section">
                <div class="section-title">词汇序列 (Words)</div>
                <div id="wordsDisplay"></div>
            </div>
        </div>
        
        <div class="technique-indicators">
            <div class="section-title">演唱技巧可视化</div>
            <div id="techniquesDisplay"></div>
        </div>
        
        <div class="info-panel">
            <div>当前时间: <span id="currentTime">0.00</span>s</div>
            <div>当前音素: <span id="currentPhoneme">-</span></div>
            <div>当前词汇: <span id="currentWord">-</span></div>
            <div>当前音符: <span id="currentNote">-</span></div>
        </div>
    </div>

    <script>
        let songData = null;
        let audioPlayer = null;
        let currentPhonemeIndex = -1;
        let currentWordIndex = -1;
        
        // 技巧名称映射
        const techniqueNames = {
            'pharyngeal_tech': '咽音技巧',
            'glissando_tech': '滑音技巧', 
            'strong_tech': '强音技巧',
            'vibrato_tech': '颤音技巧',
            'falsetto_tech': '假音技巧',
            'bubble_tech': '泡音技巧',
            'breathe_tech': '气息技巧',
            'weak_tech': '弱音技巧'
        };
        
        const techniqueColors = {
            'pharyngeal_tech': 'pharyngeal',
            'glissando_tech': 'glissando',
            'strong_tech': 'strong',
            'vibrato_tech': 'vibrato',
            'falsetto_tech': 'falsetto',
            'bubble_tech': 'bubble',
            'breathe_tech': 'breathe',
            'weak_tech': 'weak'
        };
        
        // 文件选择处理
        document.getElementById('jsonFile').addEventListener('change', handleJsonFile);
        document.getElementById('audioFile').addEventListener('change', handleAudioFile);
        
        function handleJsonFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        songData = Array.isArray(data) ? data[0] : data;
                        document.getElementById('jsonStatus').textContent = `已加载: ${file.name}`;
                        displayLyrics();
                        displayTechniques();
                    } catch (error) {
                        alert('JSON文件格式错误: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        function handleAudioFile(event) {
            const file = event.target.files[0];
            if (file) {
                const audioPlayer = document.getElementById('audioPlayer');
                const url = URL.createObjectURL(file);
                audioPlayer.src = url;
                audioPlayer.style.display = 'block';
                document.getElementById('audioStatus').textContent = `已加载: ${file.name}`;
                
                // 添加时间更新监听器
                audioPlayer.addEventListener('timeupdate', updateHighlight);
                audioPlayer.addEventListener('loadedmetadata', function() {
                    console.log('音频时长:', audioPlayer.duration);
                });
            }
        }
        
        function displayLyrics() {
            if (!songData) return;
            
            // 显示音素
            const phonemesDisplay = document.getElementById('phonemesDisplay');
            phonemesDisplay.innerHTML = '';
            songData.ph_list.forEach((phoneme, index) => {
                const span = document.createElement('span');
                span.className = 'phoneme';
                span.textContent = phoneme;
                span.id = `phoneme-${index}`;
                phonemesDisplay.appendChild(span);
            });
            
            // 显示词汇
            const wordsDisplay = document.getElementById('wordsDisplay');
            wordsDisplay.innerHTML = '';
            songData.word_list.forEach((word, index) => {
                const span = document.createElement('span');
                span.className = 'word';
                span.textContent = word;
                span.id = `word-${index}`;
                wordsDisplay.appendChild(span);
            });
        }
        
        function displayTechniques() {
            if (!songData) return;
            
            const techniquesDisplay = document.getElementById('techniquesDisplay');
            techniquesDisplay.innerHTML = '';
            
            // 为每个技巧创建可视化轨道
            Object.keys(techniqueNames).forEach(techKey => {
                if (songData[techKey] && songData[techKey].length > 0) {
                    const row = document.createElement('div');
                    row.className = 'technique-row';
                    
                    const name = document.createElement('div');
                    name.className = 'technique-name';
                    name.textContent = techniqueNames[techKey];
                    
                    const track = document.createElement('div');
                    track.className = 'technique-track';
                    track.id = `technique-${techKey}`;
                    
                    // 为每个音素创建技巧段
                    songData[techKey].forEach((value, index) => {
                        const segment = document.createElement('div');
                        segment.className = `technique-segment ${techniqueColors[techKey]} ${value ? 'technique-active' : 'technique-inactive'}`;
                        segment.style.width = `${100 / songData[techKey].length}%`;
                        segment.id = `${techKey}-${index}`;
                        track.appendChild(segment);
                    });
                    
                    row.appendChild(name);
                    row.appendChild(track);
                    techniquesDisplay.appendChild(row);
                }
            });
        }
        
        function updateHighlight() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer || !songData) return;
            
            const currentTime = audioPlayer.currentTime;
            document.getElementById('currentTime').textContent = currentTime.toFixed(2);
            
            // 更新进度条
            const progress = (currentTime / audioPlayer.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // 计算当前音素索引
            let phonemeTime = 0;
            let newPhonemeIndex = -1;
            
            for (let i = 0; i < songData.ph_durs.length; i++) {
                if (currentTime >= phonemeTime && currentTime < phonemeTime + songData.ph_durs[i]) {
                    newPhonemeIndex = i;
                    break;
                }
                phonemeTime += songData.ph_durs[i];
            }
            
            // 计算当前词汇索引
            let wordTime = 0;
            let newWordIndex = -1;
            
            for (let i = 0; i < songData.word_durs.length; i++) {
                if (currentTime >= wordTime && currentTime < wordTime + songData.word_durs[i]) {
                    newWordIndex = i;
                    break;
                }
                wordTime += songData.word_durs[i];
            }
            
            // 更新音素高亮
            if (newPhonemeIndex !== currentPhonemeIndex) {
                // 移除旧高亮
                if (currentPhonemeIndex >= 0) {
                    const oldElement = document.getElementById(`phoneme-${currentPhonemeIndex}`);
                    if (oldElement) oldElement.classList.remove('current');
                }
                
                // 添加新高亮
                if (newPhonemeIndex >= 0) {
                    const newElement = document.getElementById(`phoneme-${newPhonemeIndex}`);
                    if (newElement) {
                        newElement.classList.add('current');
                        // 滚动到视图中
                        newElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                
                currentPhonemeIndex = newPhonemeIndex;
                
                // 更新信息面板
                if (currentPhonemeIndex >= 0) {
                    document.getElementById('currentPhoneme').textContent = songData.ph_list[currentPhonemeIndex];
                    if (songData.note_list && songData.note_list[currentPhonemeIndex] !== undefined) {
                        document.getElementById('currentNote').textContent = songData.note_list[currentPhonemeIndex];
                    }
                }
            }
            
            // 更新词汇高亮
            if (newWordIndex !== currentWordIndex) {
                // 移除旧高亮
                if (currentWordIndex >= 0) {
                    const oldElement = document.getElementById(`word-${currentWordIndex}`);
                    if (oldElement) oldElement.classList.remove('current');
                }
                
                // 添加新高亮
                if (newWordIndex >= 0) {
                    const newElement = document.getElementById(`word-${newWordIndex}`);
                    if (newElement) {
                        newElement.classList.add('current');
                        newElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                
                currentWordIndex = newWordIndex;
                
                // 更新信息面板
                if (currentWordIndex >= 0) {
                    document.getElementById('currentWord').textContent = songData.word_list[currentWordIndex];
                }
            }
            
            // 高亮当前技巧段
            if (currentPhonemeIndex >= 0) {
                Object.keys(techniqueNames).forEach(techKey => {
                    if (songData[techKey] && songData[techKey].length > 0) {
                        // 移除所有当前高亮
                        const segments = document.querySelectorAll(`[id^="${techKey}-"]`);
                        segments.forEach(seg => seg.style.border = 'none');
                        
                        // 高亮当前段
                        const currentSegment = document.getElementById(`${techKey}-${currentPhonemeIndex}`);
                        if (currentSegment) {
                            currentSegment.style.border = '2px solid #333';
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
